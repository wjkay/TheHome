- id: '1744692868415'
  alias: Set Laundry Light Based on Toast Pricing
  description: 'Toast fixed night rate: 9pm-7am Off-Peak, 7am-9pm Peak'
  triggers:
  - entity_id: sensor.toast_pricing_period
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: sensor.toast_pricing_period
        state: Peak
      sequence:
      - target:
          entity_id: light.laundry_ceiling_1
        data:
          rgb_color:
          - 255
          - 64
          - 64
          brightness_pct: 75
        action: light.turn_on
    - conditions:
      - condition: state
        entity_id: sensor.toast_pricing_period
        state: Off-Peak
      sequence:
      - target:
          entity_id: light.laundry_ceiling_1
        data:
          rgb_color:
          - 0
          - 200
          - 83
          brightness_pct: 75
        action: light.turn_on
  mode: single
- id: '1746146866850'
  alias: 'Sensor Light - Office '
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.office_motion
      light_switch:
        entity_id:
        - light.office_ceiling_1_2
        - light.office_ceiling_2
        - light.office_ceiling_3_3
      include_dynamic_lighting: disable_dynamic_lighting
      include_ambient: ambient_enabled
      ambient_light_sensor: sensor.office_motion_illuminance
      ambient_light_options: ambient_light_option_enabled
      include_light_control:
      - use_brightness
      - use_transition
      include_bypass: []
- id: '1748939674348'
  alias: Sensor Light - Laundry
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.laundry_motion_2
      - binary_sensor.laundry_sensor_2
      light_switch:
        entity_id:
        - light.laundry_light
        - light.laundry_hall_light
      include_light_control:
      - use_brightness
      - use_transition
      time_delay: 5
      light_transition_on: 2
      light_transition_off: 10
- id: '1748940381626'
  alias: Sensor Light - Garage
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.garage_motion_3
      - binary_sensor.garage_door_opening
      light_switch:
        entity_id:
        - light.garage_1
        - light.garage_2
        - switch.garage_fluro
      include_light_control:
      - use_brightness
      - use_transition
      include_light_colour_control: disable_colour_control
- id: '1748945017821'
  alias: Living motion
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.living_room_motion_4
      light_switch:
        entity_id:
        - light.livingroom_pendant
        - light.couch_1_2
        - light.couch_2_3
        - light.tapo_smart_bulb
        - light.dining_ceiling_2
      include_dynamic_lighting: enable_sun_elevation_colour_lux_brightness
- id: '1748946773226'
  alias: Sensor - hall
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.hall_sensor
      light_switch:
        entity_id: light.bathroom_2
      time_delay: 1
      include_light_control:
      - use_brightness
      - use_transition
      light_brightness: 32
      light_transition_on: 5
      light_transition_off: 10
      include_light_colour_control: disable_colour_control
- id: '1749069565541'
  alias: Sensor light - boys loo
  description: ''
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.boys_loo_2
      light_switch:
        entity_id: light.boys_loo
      include_light_control:
      - use_brightness
      - use_transition
      time_delay: 5
      light_transition_on: 2
      light_transition_off: 2
- id: '1765521912306'
  alias: 'Toggle Lucas '
  description: ''
  triggers:
  - type: changed_states
    device_id: cd11261502cb2060a8ecb16f92a2c340
    entity_id: cd6175de9710f35215690fa9561bc175
    domain: switch
    trigger: device
  conditions: []
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.bedside_1_2
  mode: single

- id: '1769714000001'
  alias: EV Charging - 9pm Check
  description: At 9pm, remind to plug in if low battery, or start charging if plugged in
  triggers:
  - trigger: time
    at: "21:00:00"
  conditions:
  - condition: state
    entity_id: device_tracker.mg_mg4_gps_location
    state: home
  actions:
  - choose:
    # Low battery and NOT plugged in - send reminder
    - conditions:
      - condition: numeric_state
        entity_id: sensor.mg_mg4_state_of_charge
        below: 50
      - condition: state
        entity_id: binary_sensor.mg_mg4_charging_gun_state
        state: 'off'
      sequence:
      - action: notify.mobile_app_sm_s928b
        data:
          title: "Plug in the MG!"
          message: "Battery at {{ states('sensor.mg_mg4_state_of_charge') }}% - night rate starts now (9pm-7am)"
    # Plugged in and needs charge - start charging sequence
    - conditions:
      - condition: numeric_state
        entity_id: sensor.mg_mg4_state_of_charge
        below: 90
      - condition: state
        entity_id: binary_sensor.mg_mg4_charging_gun_state
        state: 'on'
      sequence:
      # Record starting SOC
      - action: input_number.set_value
        target:
          entity_id: input_number.ev_charge_start_soc
        data:
          value: "{{ states('sensor.mg_mg4_state_of_charge') | float }}"
      - action: switch.turn_on
        target:
          entity_id: switch.car_charger
      - delay:
          seconds: 30
      - action: switch.turn_on
        target:
          entity_id: switch.mg_mg4_charging
      - action: notify.mobile_app_sm_s928b
        data:
          title: "EV Charging Started"
          message: "Night rate active. Battery at {{ states('sensor.mg_mg4_state_of_charge') }}%"
      # Wait and verify charging started
      - delay:
          seconds: 60
      - choose:
        - conditions:
          - condition: state
            entity_id: sensor.mg_mg4_charging_status
            state: 'Idle'
          sequence:
          # Retry turning on charging
          - action: switch.turn_on
            target:
              entity_id: switch.mg_mg4_charging
          - delay:
              seconds: 30
          - choose:
            - conditions:
              - condition: state
                entity_id: sensor.mg_mg4_charging_status
                state: 'Idle'
              sequence:
              - action: notify.mobile_app_sm_s928b
                data:
                  title: "EV Charging Failed"
                  message: "Charger on but MG not responding. Check app manually."
  mode: single

- id: '1769714000002'
  alias: EV Charging - Plugged In After 9pm
  description: Start charging if plugged in during night rate (after reminder)
  triggers:
  - entity_id: binary_sensor.mg_mg4_charging_gun_state
    to: 'on'
    trigger: state
  conditions:
  - condition: state
    entity_id: sensor.toast_pricing_period
    state: 'Off-Peak'
  - condition: numeric_state
    entity_id: sensor.mg_mg4_state_of_charge
    below: 90
  - condition: state
    entity_id: device_tracker.mg_mg4_gps_location
    state: home
  actions:
  # Record starting SOC
  - action: input_number.set_value
    target:
      entity_id: input_number.ev_charge_start_soc
    data:
      value: "{{ states('sensor.mg_mg4_state_of_charge') | float }}"
  - action: switch.turn_on
    target:
      entity_id: switch.car_charger
  - delay:
      seconds: 30
  - action: switch.turn_on
    target:
      entity_id: switch.mg_mg4_charging
  - action: notify.mobile_app_sm_s928b
    data:
      title: "EV Charging Started"
      message: "Plugged in during night rate. Battery at {{ states('sensor.mg_mg4_state_of_charge') }}%"
  - delay:
      seconds: 60
  - condition: state
    entity_id: sensor.mg_mg4_charging_status
    state: 'Idle'
  - action: switch.turn_on
    target:
      entity_id: switch.mg_mg4_charging
  mode: single

- id: '1769714000003'
  alias: EV Charging - Stop at 7am
  description: Stop EV charging when Toast night rate ends at 7am (unless override)
  triggers:
  - trigger: time
    at: "07:00:00"
  conditions:
  - condition: state
    entity_id: input_boolean.ev_charge_override
    state: 'off'
  - condition: or
    conditions:
    - condition: state
      entity_id: switch.car_charger
      state: 'on'
    - condition: state
      entity_id: switch.mg_mg4_charging
      state: 'on'
  actions:
  - action: switch.turn_off
    target:
      entity_id: switch.mg_mg4_charging
  - delay:
      seconds: 10
  - action: switch.turn_off
    target:
      entity_id: switch.car_charger
  # Send summary with charge gained (only if > 0)
  - variables:
      start_soc: "{{ states('input_number.ev_charge_start_soc') | float }}"
      end_soc: "{{ states('sensor.mg_mg4_state_of_charge') | float }}"
      gained: "{{ (end_soc - start_soc) | round(1) }}"
  - condition: template
    value_template: "{{ gained > 0 }}"
  - action: notify.mobile_app_sm_s928b
    data:
      title: "EV Charging Summary"
      message: "Night rate ended. Battery {{ start_soc | round(0) }}% → {{ end_soc | round(0) }}% (+{{ gained }}%)"
  mode: single

- id: '1769714000004'
  alias: EV Charging - Complete
  description: Notify and stop when EV reaches target charge
  triggers:
  - entity_id: sensor.mg_mg4_state_of_charge
    above: 89
    trigger: numeric_state
  conditions:
  - condition: or
    conditions:
    - condition: state
      entity_id: switch.car_charger
      state: 'on'
    - condition: state
      entity_id: switch.mg_mg4_charging
      state: 'on'
  actions:
  - variables:
      start_soc: "{{ states('input_number.ev_charge_start_soc') | float }}"
      end_soc: "{{ states('sensor.mg_mg4_state_of_charge') | float }}"
      gained: "{{ (end_soc - start_soc) | round(1) }}"
  # Only notify if we actually charged something
  - condition: template
    value_template: "{{ gained > 0 }}"
  - action: notify.mobile_app_sm_s928b
    data:
      title: "EV Charging Complete"
      message: "Battery {{ start_soc | round(0) }}% → {{ end_soc | round(0) }}% (+{{ gained }}%)"
  - delay:
      minutes: 2
  - action: switch.turn_off
    target:
      entity_id: switch.mg_mg4_charging
  - delay:
      seconds: 10
  - action: switch.turn_off
    target:
      entity_id: switch.car_charger
  mode: single

- id: '1769714000005'
  alias: Sensor Light - Workshop
  description: Motion-activated workshop light
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.workshop_sensor
      light_switch:
        entity_id:
        - light.workshop_1
      include_light_control:
      - use_brightness
      - use_transition
      time_delay: 10
      light_transition_on: 1
      light_transition_off: 5
      include_light_colour_control: disable_colour_control

- id: '1769714000006'
  alias: Sensor Light - Mezzanine
  description: Motion-activated mezzanine lamp
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.mezzanine_motion_5
      light_switch:
        entity_id:
        - light.mezzanine_lamp
      include_light_control:
      - use_brightness
      - use_transition
      time_delay: 15
      light_brightness: 50
      light_transition_on: 3
      light_transition_off: 10

- id: '1769714000007'
  alias: Sensor Light - Stairs
  description: Motion-activated stair lights using hall sensors
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.hall_sensor
      - binary_sensor.hall_cupboard
      light_switch:
        entity_id:
        - light.stairs_1
        - light.stair_2
      include_light_control:
      - use_brightness
      - use_transition
      time_delay: 3
      light_brightness: 40
      light_transition_on: 2
      light_transition_off: 5

- id: '1769714000008'
  alias: Lights Off at 11pm
  description: Turn off all lights at 11pm
  triggers:
  - trigger: time
    at: "23:00:00"
  conditions: []
  actions:
  - action: light.turn_off
    target:
      entity_id: all
  mode: single
